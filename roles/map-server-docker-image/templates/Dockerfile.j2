FROM node:0.12
MAINTAINER Reittiopas version: 0.1

RUN apt-get update
RUN apt-get install -y git npm

RUN mkdir -p {{map_server_root}}

WORKDIR {{map_server_root}}

RUN echo "{{ansible_date_time.epoch}}" > build_date

RUN npm install tessera
RUN npm install tilelive-tmstyle
RUN npm install tilelive-http

RUN echo "{{ansible_date_time.epoch}}" > build_date

RUN git clone {{map_server_style_git}} {{map_server_style}}

RUN sed -i -e 's#source: "http://tiletest.kapsi.fi:8080/index.json"#source: "tilejson+http://vectormapserver:{{vector_map_server_exposed_port}}/index.json"#' {{map_server_style}}/project.yml

EXPOSE {{map_server_exposed_port}}

CMD sleep 500 && node node_modules/tessera/bin/tessera.js --port {{map_server_exposed_port}} tmstyle://./{{map_server_style}}/

