worker_processes 1;

events { worker_connections 1024; }

daemon off;

# NOTE: use only absolute redirects and host part $http_host,
# because nginx doesn't copy port to redirects but always adds :8080

http {

    sendfile on;

    gzip              on;
    gzip_http_version 1.0;
    gzip_proxied      any;
    gzip_min_length   500;
    gzip_disable      "MSIE [1-6]\.";
    gzip_types        text/plain
                      text/xml
                      text/css
                      text/comma-separated-values
                      text/javascript
                      application/javascript
                      application/json
                      application/x-javascript
                      application/atom+xml;

    proxy_temp_path {{reverse_proxy_root}}/temp-cache;
    proxy_cache_path {{reverse_proxy_root}}/cache levels=1:2 keys_zone=tiles:10m max_size=4g inactive=7d use_temp_path=off;

    server {
        listen {{reverse_proxy_exposed_port}};
        server_name matka.hsl.fi dev.reittiopas.fi;

        location / {
            proxy_pass         http://digitransituiregional:{{digitransit_ui_exposed_port}};
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name;
        }

        location ~ ^/digitransit-ui/? {
            rewrite /digitransit-ui/?(.*) http://$host/$1 permanent;
        }

        include common.conf;
    }

    server {
        listen {{reverse_proxy_exposed_port}};
        server_name dev.digitransit.fi beta.digitransit.fi;

        location / {
            proxy_pass         http://digitransitui:{{digitransit_ui_exposed_port}};
            proxy_redirect     off;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Host $server_name;
        }

        location ~ ^/digitransit-ui/? {
            rewrite /digitransit-ui/?(.*) http://$host/$1 permanent;
        }

        include common.conf;
    }

    # Configuration for the server
    server {
        listen {{reverse_proxy_exposed_port}};
        server_name digitransit.fi www.digitransit.fi;

        location / {
            include /etc/nginx/mime.types;
            root {{reverse_proxy_root}}/site/public;
        }

        location ~ ^/digitransit-ui/? {
            rewrite /digitransit-ui/?(.*) http://$host/$1 permanent;
        }

        include common.conf;
    }

    server {
        listen {{reverse_proxy_exposed_port}};
        server_name digitransit.com www.digitransit.com;

        rewrite  ^/(.*)$  http://digitransit.fi/$1 permanent;
    }
}
