#!/bin/bash
set -e

gosu postgres postgres &

wget http://download.geofabrik.de/europe/finland-latest.osm.pbf

gosu postgres psql -c "create database osm_tanzania;"
gosu postgres psql -d osm_tanzania -c "CREATE EXTENSION postgis;"
gosu postgres psql -d osm_tanzania -c "SELECT postgis_full_version();"
gosu postgres psql -d osm_tanzania -f postgis-vt-util/lib.sql

imposm --connection "postgis://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:5432/osm_tanzania" -m osm-bright.tm2source/imposm-mapping.py --read --write --optimize --deploy-production-tables --overwrite-cache finland-latest.osm.pbf

gosu postgres psql -d osm_tanzania -f osm-bright.tm2source/create-indices.sql

ogr2ogr -progress -f PostgreSQL PG:"dbname=osm_tanzania user=${POSTGRES_USER} password=${POSTGRES_PASSWORD}" -a_srs EPSG:3857 -clipsrc 1553110 6986810 4355924 13733944 -lco GEOMETRY_NAME=geometry -nlt PROMOTE_TO_MULTI -overwrite /vsizip//vsicurl/http://data.openstreetmapdata.com/water-polygons-split-3857.zip/water-polygons-split-3857/water_polygons.shp

gosu postgres psql -c "ALTER DATABASE osm_tanzania SET default_transaction_read_only = true;"

sleep 10